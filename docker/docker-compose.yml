version: '3.0'
services:
  app:
    build: 
      context: .
      dockerfile: ./app/go/Dockerfile
    platform: linux/amd64
    environment:
      ISHOCON_APP_LANG: "${ISHOCON_APP_LANG-go}"
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/ishocon-app"]
      interval: 30s
      timeout: 3s
      retries: 5
      start_period: 10s
    command: ["CMD", "sh", "-c", "/home/ishocon/run.sh", "&&", "tail", "-f", "/dev/null"]
    tty: true
    volumes:
      - storage_app:/var/lib/mysql
      - ./webapp:/home/ishocon/webapp
    ports:
      - "443:443"

  bench:
    image: showwin/ishocon2_bench:latest
    command: tail -f /dev/null
    volumes:
      - storage_bench:/var/lib/mysql
    links:
      - app
    environment: 
      - TARGET=app
    depends_on:
      app:
        condition: service_healthy

volumes:
  storage_bench:
  storage_app:
